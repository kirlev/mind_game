/**
 * KineticJS JavaScript Library v3.9.8
 * http://www.kineticjs.com/
 * Copyright 2012, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Jun 03 2012
 *
 * Copyright (C) 2011 - 2012 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
var Kinetic={};Kinetic.GlobalObject={stages:[],idCounter:0,tempNodes:[],animations:[],animIdCounter:0,animRunning:!1,maxDragTimeInterval:20,frame:{time:0,timeDiff:0,lastTime:0},drag:{moving:!1,node:void 0,offset:{x:0,y:0},lastDrawTime:0},extend:function(t,i){for(var e in i.prototype)i.prototype.hasOwnProperty(e)&&void 0===t.prototype[e]&&(t.prototype[e]=i.prototype[e])},_pullNodes:function(t){for(var i=this.tempNodes,e=0;i.length>e;e++){var s=i[e];void 0!==s.getStage()&&s.getStage()._id===t._id&&(t._addId(s),t._addName(s),this.tempNodes.splice(e,1),e-=1)}},_addAnimation:function(t){t.id=this.animIdCounter++,this.animations.push(t)},_removeAnimation:function(t){for(var i=t.id,e=this.animations,s=0;e.length>s;s++)if(e[s].id===i)return this.animations.splice(s,1),!1},_runFrames:function(){for(var t={},i=0;this.animations.length>i;i++){var e=this.animations[i];e.node&&void 0!==e.node._id&&(t[e.node._id]=e.node),e.func(this.frame)}for(var s in t)t[s].draw()},_updateFrameObject:function(){var t=new Date,i=t.getTime();0===this.frame.lastTime?this.frame.lastTime=i:(this.frame.timeDiff=i-this.frame.lastTime,this.frame.lastTime=i,this.frame.time+=this.frame.timeDiff)},_animationLoop:function(){if(this.animations.length>0){this._updateFrameObject(),this._runFrames();var t=this;requestAnimFrame(function(){t._animationLoop()})}else this.animRunning=!1,this.frame.lastTime=0},_handleAnimation:function(){var t=this;this.animRunning?this.frame.lastTime=0:(this.animRunning=!0,t._animationLoop())},_isElement:function(t){return!(!t||1!=t.nodeType)},_isFunction:function(t){return!!(t&&t.constructor&&t.call&&t.apply)},_isArray:function(t){return void 0!==t.length},_isObject:function(t){return t===Object(t)},_isNumber:function(t){return"[object Number]"==Object.prototype.toString.call(t)},_hasMethods:function(t){var i=[];for(var e in t)this._isFunction(t[e])&&i.push(e);return i.length>0},_getXY:function(t){if(this._isNumber(t))return{x:t,y:t};if(this._isArray(t)){if(1===t.length){var i=t[0];if(this._isNumber(i))return{x:i,y:i};if(this._isArray(i))return{x:i[0],y:i[1]};if(this._isObject(i))return i}else if(t.length>=2)return{x:t[0],y:t[1]}}else if(this._isObject(t))return t;return{x:0,y:0}},_getSize:function(t){if(this._isNumber(t))return{width:t,height:t};if(this._isArray(t))if(1===t.length){var i=t[0];if(this._isNumber(i))return{width:i,height:i};if(this._isArray(i)){if(i.length>=4)return{width:i[2],height:i[3]};if(i.length>=2)return{width:i[0],height:i[1]}}else if(this._isObject(i))return i}else{if(t.length>=4)return{width:t[2],height:t[3]};if(t.length>=2)return{width:t[0],height:t[1]}}else if(this._isObject(t))return t;return{width:0,height:0}},_getPoints:function(t){if(void 0===t)return[];if(this._isObject(t[0]))return t;for(var i=[],e=0;t.length>e;e+=2)i.push({x:t[e],y:t[e+1]});return i},_setAttr:function(t,i,e){void 0!==e&&(t[i]=e)}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),Kinetic.Node=function(t){this.defaultNodeAttrs={visible:!0,listening:!0,name:void 0,alpha:1,x:0,y:0,scale:{x:1,y:1},rotation:0,centerOffset:{x:0,y:0},dragConstraint:"none",dragBounds:{},draggable:!1},this.setDefaultAttrs(this.defaultNodeAttrs),this.eventListeners={},this.setAttrs(t)},Kinetic.Node.prototype={on:function(t,i){for(var e=t.split(" "),s=0;e.length>s;s++){var n=e[s],a=n,r=a.split("."),h=r[0],o=r.length>1?r[1]:"";this.eventListeners[h]||(this.eventListeners[h]=[]),this.eventListeners[h].push({name:o,handler:i})}},off:function(t){for(var i=t.split(" "),e=0;i.length>e;e++){var s=i[e],n=s,a=n.split("."),r=a[0];if(this.eventListeners[r]&&a.length>1){for(var h=a[1],o=0;this.eventListeners[r].length>o;o++)if(this.eventListeners[r][o].name===h){this.eventListeners[r].splice(o,1),0===this.eventListeners[r].length&&(this.eventListeners[r]=void 0);break}}else this.eventListeners[r]=void 0}},getAttrs:function(){return this.attrs},setDefaultAttrs:function(t){if(void 0===this.attrs&&(this.attrs={}),t)for(var i in t)void 0===this.attrs[i]&&(this.attrs[i]=t[i])},setAttrs:function(t){function i(t,n){for(var a in n){var r=n[a];if(void 0===t[a]&&(t[a]={}),!e._isObject(r)||e._isArray(r)||e._isElement(r)||e._hasMethods(r))switch(a){case"draggable":s.draggable(n[a]);break;case"listening":s.listen(n[a]);break;case"rotationDeg":t.rotation=n[a]*Math.PI/180;break;case"centerOffset":var h=e._getXY(r);e._setAttr(t[a],"x",h.x),e._setAttr(t[a],"y",h.y);break;case"offset":var h=e._getXY(r);e._setAttr(t[a],"x",h.x),e._setAttr(t[a],"y",h.y);break;case"scale":var h=e._getXY(r);e._setAttr(t[a],"x",h.x),e._setAttr(t[a],"y",h.y);break;case"points":t[a]=e._getPoints(r);break;case"crop":var h=e._getXY(r),o=e._getSize(r);e._setAttr(t[a],"x",h.x),e._setAttr(t[a],"y",h.y),e._setAttr(t[a],"width",o.width),e._setAttr(t[a],"height",o.height);break;default:t[a]=n[a]}else void 0===t[a]&&(t[a]={}),i(t[a],r)}}var e=Kinetic.GlobalObject,s=this;void 0!==t&&i(this.attrs,t)},isVisible:function(){return this.getParent()&&!this.getParent().isVisible()?!1:this.attrs.visible},show:function(){this.attrs.visible=!0},hide:function(){this.attrs.visible=!1},getZIndex:function(){return this.index},getAbsoluteZIndex:function(){function t(n){for(var a=[],r=0;n.length>r;r++){var h=n[r];s++,"Shape"!==h.nodeType&&(a=a.concat(h.getChildren())),h._id===e._id&&(r=n.length)}a.length>0&&i>=a[0].getLevel()&&t(a)}var i=this.getLevel();this.getStage();var e=this,s=0;return"Stage"!==e.nodeType&&t(e.getStage().getChildren()),s},getLevel:function(){for(var t=0,i=this.parent;i;)t++,i=i.parent;return t},setScale:function(){this.setAttrs({scale:arguments})},getScale:function(){return this.attrs.scale},setPosition:function(){var t=Kinetic.GlobalObject._getXY(arguments);this.setAttrs(t)},setX:function(t){this.attrs.x=t},setY:function(t){this.attrs.y=t},getX:function(){return this.attrs.x},getY:function(){return this.attrs.y},setDetectionType:function(t){this.attrs.detectionType=t},getDetectionType:function(){return this.attrs.detectionType},getPosition:function(){return{x:this.attrs.x,y:this.attrs.y}},getAbsolutePosition:function(){return this.getAbsoluteTransform().getTranslation()},setAbsolutePosition:function(){var t=Kinetic.GlobalObject._getXY(arguments),i=this.attrs.rotation,e={x:this.attrs.scale.x,y:this.attrs.scale.y};({x:this.attrs.centerOffset.x,y:this.attrs.centerOffset.y}),this.attrs.rotation=0,this.attrs.scale={x:1,y:1};var s=this.getAbsoluteTransform();s.invert(),s.translate(t.x,t.y),t={x:this.attrs.x+s.getTranslation().x,y:this.attrs.y+s.getTranslation().y},this.setPosition(t.x,t.y),this.rotate(i),this.attrs.scale={x:e.x,y:e.y}},move:function(t,i){this.attrs.x+=t,this.attrs.y+=i},setRotation:function(t){this.attrs.rotation=t},setRotationDeg:function(t){this.attrs.rotation=t*Math.PI/180},getRotation:function(){return this.attrs.rotation},getRotationDeg:function(){return 180*this.attrs.rotation/Math.PI},rotate:function(t){this.attrs.rotation+=t},rotateDeg:function(t){this.attrs.rotation+=t*Math.PI/180},listen:function(t){this.attrs.listening=t},moveToTop:function(){var t=this.index;this.parent.children.splice(t,1),this.parent.children.push(this),this.parent._setChildrenIndices()},moveUp:function(){var t=this.index;this.parent.children.splice(t,1),this.parent.children.splice(t+1,0,this),this.parent._setChildrenIndices()},moveDown:function(){var t=this.index;t>0&&(this.parent.children.splice(t,1),this.parent.children.splice(t-1,0,this),this.parent._setChildrenIndices())},moveToBottom:function(){var t=this.index;this.parent.children.splice(t,1),this.parent.children.unshift(this),this.parent._setChildrenIndices()},setZIndex:function(t){var i=this.index;this.parent.children.splice(i,1),this.parent.children.splice(t,0,this),this.parent._setChildrenIndices()},setAlpha:function(t){this.attrs.alpha=t},getAlpha:function(){return this.attrs.alpha},getAbsoluteAlpha:function(){for(var t=1,i=this;"Stage"!==i.nodeType;)t*=i.attrs.alpha,i=i.parent;return t},draggable:function(t){this.attrs.draggable!==t&&(t?this._listenDrag():this._dragCleanup(),this.attrs.draggable=t)},isDragging:function(){var t=Kinetic.GlobalObject;return void 0!==t.drag.node&&t.drag.node._id===this._id&&t.drag.moving},moveTo:function(t){var i=this.parent;i.children.splice(this.index,1),i._setChildrenIndices(),t.children.push(this),this.index=t.children.length-1,this.parent=t,t._setChildrenIndices()},getParent:function(){return this.parent},getLayer:function(){return"Layer"===this.nodeType?this:this.getParent().getLayer()},getStage:function(){return"Stage"===this.nodeType?this:void 0===this.getParent()?void 0:this.getParent().getStage()},getName:function(){return this.attrs.name},getId:function(){return this.attrs.id},simulate:function(t){for(var i=this.eventListeners[t],e=0;i.length>e;e++)i[e].handler.call(this)},setCenterOffset:function(){this.setAttrs({centerOffset:arguments})},getCenterOffset:function(){return this.attrs.centerOffset},transitionTo:function(t){var i=Kinetic.GlobalObject;void 0!==this.transAnim&&(i._removeAnimation(this.transAnim),this.transAnim=void 0);var e="Stage"===this.nodeType?this:this.getLayer(),s=this,n=new Kinetic.Transition(this,t),a={func:function(){n._onEnterFrame()},node:e};return this.transAnim=a,i._addAnimation(a),n.onFinished=function(){i._removeAnimation(a),s.transAnim=void 0,void 0!==t.callback&&t.callback(),a.node.draw()},n.start(),i._handleAnimation(),n},setDragConstraint:function(t){this.attrs.dragConstraint=t},getDragConstraint:function(){return this.attrs.dragConstraint},setDragBounds:function(t){this.attrs.dragBounds=t},getDragBounds:function(){return this.attrs.dragBounds},getAbsoluteTransform:function(){var t=new Kinetic.Transform,i=[],e=this.parent;for(i.unshift(this);e;)i.unshift(e),e=e.parent;for(var s=0;i.length>s;s++){var n=i[s],a=n.getTransform();t.multiply(a)}return t},getTransform:function(){var t=new Kinetic.Transform;return(0!==this.attrs.x||0!==this.attrs.y)&&t.translate(this.attrs.x,this.attrs.y),0!==this.attrs.rotation&&t.rotate(this.attrs.rotation),(1!==this.attrs.scale.x||1!==this.attrs.scale.y)&&t.scale(this.attrs.scale.x,this.attrs.scale.y),t},_listenDrag:function(){this._dragCleanup(),Kinetic.GlobalObject;var t=this;this.on("mousedown.initdrag touchstart.initdrag",function(){t._initDrag()})},_initDrag:function(){var t=Kinetic.GlobalObject,i=this.getStage(),e=i.getUserPosition();e&&(this.getTransform().getTranslation(),this.getAbsoluteTransform().getTranslation(),t.drag.node=this,t.drag.offset.x=e.x-this.getAbsoluteTransform().getTranslation().x,t.drag.offset.y=e.y-this.getAbsoluteTransform().getTranslation().y)},_dragCleanup:function(){this.off("mousedown.initdrag"),this.off("touchstart.initdrag")},_handleEvents:function(t,i){"Shape"===this.nodeType&&(i.shape=this);var e=this.getStage();this._handleEvent(this,e.mouseoverShape,e.mouseoutShape,t,i)},_handleEvent:function(t,i,e,s,n){var a=t.eventListeners,r=!0;if("mouseover"===s&&e&&e._id===t._id?r=!1:"mouseout"===s&&i&&i._id===t._id&&(r=!1),a[s]&&r)for(var h=a[s],o=0;h.length>o;o++)h[o].handler.apply(t,[n]);var c=i?i.parent:void 0,u=e?e.parent:void 0;!n.cancelBubble&&t.parent&&"Stage"!==t.parent.nodeType&&this._handleEvent(t.parent,c,u,s,n)}},Kinetic.Container=function(){this.children=[]},Kinetic.Container.prototype={getChildren:function(){return this.children},removeChildren:function(){for(;this.children.length>0;)this.remove(this.children[0])},add:function(t){t._id=Kinetic.GlobalObject.idCounter++,t.index=this.children.length,t.parent=this,this.children.push(t);var i=t.getStage();if(void 0===i){var e=Kinetic.GlobalObject;e.tempNodes.push(t)}else{i._addId(t),i._addName(t);var e=Kinetic.GlobalObject;e._pullNodes(i)}return void 0!==this._add&&this._add(t),this},remove:function(t){if(t&&void 0!==t.index&&this.children[t.index]._id==t._id){var i=this.getStage();void 0!==i&&(i._removeId(t),i._removeName(t));for(var e=Kinetic.GlobalObject,s=0;e.tempNodes.length>s;s++){var n=e.tempNodes[s];if(n._id===t._id){e.tempNodes.splice(s,1);break}}if(this.children.splice(t.index,1),this._setChildrenIndices(),t.children)for(var s=0;t.children.length>s;s++)t.remove(t.children[s]);void 0!==this._remove&&this._remove(t)}return this},get:function(t){var i,e=this.getStage(),s=t.slice(1);if("#"===t.charAt(0))i=void 0!==e.ids[s]?[e.ids[s]]:[];else{if("."!==t.charAt(0))return"Shape"===t||"Group"===t||"Layer"===t?this._getNodes(t):!1;i=void 0!==e.names[s]?e.names[s]:[]}for(var n=[],a=0;i.length>a;a++){var r=i[a];this.isAncestorOf(r)&&n.push(r)}return n},isAncestorOf:function(t){if("Stage"===this.nodeType)return!0;for(var i=t.getParent();i;){if(i._id===this._id)return!0;i=i.getParent()}return!1},_getNodes:function(t){function i(s){for(var n=s.getChildren(),a=0;n.length>a;a++){var r=n[a];r.nodeType===t?e.push(r):"Shape"!==r.nodeType&&i(r)}}var e=[];return i(this),e},_drawChildren:function(){for(var t=this.getStage(),i=this.children,e=0;i.length>e;e++){var s=i[e];"Shape"===s.nodeType?s.isVisible()&&t.isVisible()&&s._draw(s.getLayer()):s.draw()}},_setChildrenIndices:function(){if("Stage"===this.nodeType){var t=this.content.children,i=t[0],e=t[1];this.content.innerHTML="",this.content.appendChild(i),this.content.appendChild(e)}for(var s=0;this.children.length>s;s++)this.children[s].index=s,"Stage"===this.nodeType&&this.content.appendChild(this.children[s].canvas)}},Kinetic.Stage=function(t){this.setDefaultAttrs({width:400,height:200,throttle:80}),this.nodeType="Stage",this.lastEventTime=0,"string"==typeof t.container&&(t.container=document.getElementById(t.container)),Kinetic.Container.apply(this,[]),Kinetic.Node.apply(this,[t]),this.content=document.createElement("div"),this.dblClickWindow=400,this._setStageDefaultProperties(),this._id=Kinetic.GlobalObject.idCounter++,this._buildDOM(),this._listen(),this._prepareDrag();var i=Kinetic.GlobalObject;i.stages.push(this),this._addId(this),this._addName(this)},Kinetic.Stage.prototype={onFrame:function(t){Kinetic.GlobalObject,this.anim={func:t}},start:function(){if(!this.animRunning){var t=Kinetic.GlobalObject;t._addAnimation(this.anim),t._handleAnimation(),this.animRunning=!0}},stop:function(){var t=Kinetic.GlobalObject;t._removeAnimation(this.anim),this.animRunning=!1},draw:function(){this._drawChildren()},setSize:function(){var t=Kinetic.GlobalObject._getSize(arguments);this.setAttrs(t),this.attrs.width=Math.round(this.attrs.width),this.attrs.height=Math.round(this.attrs.height);var i=this.attrs.width,e=this.attrs.height;this.content.style.width=i+"px",this.content.style.height=e+"px",this.bufferLayer.getCanvas().width=i,this.bufferLayer.getCanvas().height=e,this.pathLayer.getCanvas().width=i,this.pathLayer.getCanvas().height=e;for(var s=this.children,n=0;s.length>n;n++){var a=s[n];a.getCanvas().width=i,a.getCanvas().height=e,a.draw()}},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}},clear:function(){for(var t=this.children,i=0;t.length>i;i++)t[i].clear()},toDataURL:function(t,i,e){function s(h){var o=r[h].getCanvas().toDataURL(),c=new Image;c.onload=function(){if(a.drawImage(this,0,0),h++,r.length>h)s(h);else try{t(n.getCanvas().toDataURL(i,e))}catch(o){t(n.getCanvas().toDataURL())}},c.src=o}var n=this.bufferLayer,a=n.getContext(),r=this.children;n.clear(),s(0)},toJSON:function(){function t(e){var s={},n=e.attrs;for(var a in n){var r=n[a];(i._isFunction(r)||i._isElement(r)||i._hasMethods(r))&&(n[a]=void 0)}if(s.attrs=n,s.nodeType=e.nodeType,s.shapeType=e.shapeType,"Shape"!==e.nodeType){s.children=[];for(var h=e.getChildren(),o=0;h.length>o;o++){var c=h[o];s.children.push(t(c))}}return s}var i=Kinetic.GlobalObject;return JSON.stringify(t(this))},reset:function(){this.removeChildren(),this._setStageDefaultProperties(),this.setAttrs(this.defaultNodeAttrs)},load:function(t){function i(t,e){var s=e.children;if(void 0!==s)for(var n=0;s.length>n;n++){var a,r=s[n];a="Shape"===r.nodeType?void 0===r.shapeType?"Shape":r.shapeType:r.nodeType;var h=new Kinetic[a](r.attrs);t.add(h),i(h,r)}}this.reset();var e=JSON.parse(t);this.attrs=e.attrs,i(this,e),this.draw()},getMousePosition:function(){return this.mousePos},getTouchPosition:function(){return this.touchPos},getUserPosition:function(){return this.getTouchPosition()||this.getMousePosition()},getContainer:function(){return this.attrs.container},getContent:function(){return this.content},getStage:function(){return this},getWidth:function(){return this.attrs.width},getHeight:function(){return this.attrs.height},getIntersections:function(){for(var t=Kinetic.GlobalObject._getXY(arguments),i=[],e=this.get("Shape"),s=0;e.length>s;s++){var n=e[s];n.intersects(t)&&i.push(n)}return i},getDOM:function(){return this.content},_remove:function(t){try{this.content.removeChild(t.canvas)}catch(i){}},_add:function(t){t.canvas.width=this.attrs.width,t.canvas.height=this.attrs.height,t.draw(),this.content.appendChild(t.canvas),t.lastDrawTime=0},_detectEvent:function(t,i){var e=Kinetic.GlobalObject.drag.moving,s=Kinetic.GlobalObject,n=this.getUserPosition();if(t.eventListeners,this.targetShape&&t._id===this.targetShape._id&&(this.targetFound=!0),t.isVisible()&&void 0!==n&&t.intersects(n)){if(!e&&this.mouseDown)return this.mouseDown=!1,this.clickStart=!0,t._handleEvents("mousedown",i),!0;if(this.mouseUp)return this.mouseUp=!1,t._handleEvents("mouseup",i),this.clickStart&&(s.drag.moving&&s.drag.node||(t._handleEvents("click",i),t.inDoubleClickWindow&&t._handleEvents("dblclick",i),t.inDoubleClickWindow=!0,setTimeout(function(){t.inDoubleClickWindow=!1},this.dblClickWindow))),!0;if(!e&&this.touchStart)return this.touchStart=!1,this.tapStart=!0,t._handleEvents("touchstart",i),!0;if(this.touchEnd)return this.touchEnd=!1,t._handleEvents("touchend",i),this.tapStart&&(s.drag.moving&&s.drag.node||(t._handleEvents("tap",i),t.inDoubleClickWindow&&t._handleEvents("dbltap",i),t.inDoubleClickWindow=!0,setTimeout(function(){t.inDoubleClickWindow=!1},this.dblClickWindow))),!0;if(!e&&this._isNewTarget(t,i))return this.mouseoutShape&&(this.mouseoverShape=t,this.mouseoutShape._handleEvents("mouseout",i),this.mouseoverShape=void 0),t._handleEvents("mouseover",i),this._setTarget(t),!0;if(!e&&this.mouseMove)return t._handleEvents("mousemove",i),!0;if(!e&&this.touchMove)return t._handleEvents("touchmove",i),!0}else if(!e&&this.targetShape&&this.targetShape._id===t._id)return this._setTarget(void 0),this.mouseoutShape=t,!0;return!1},_setTarget:function(t){this.targetShape=t,this.targetFound=!0},_isNewTarget:function(t){if(!this.targetShape||!this.targetFound&&t._id!==this.targetShape._id){if(this.targetShape){var i=this.targetShape.eventListeners;i&&(this.mouseoutShape=this.targetShape)}return!0}return!1},_traverseChildren:function(t,i){for(var e=t.children,s=e.length-1;s>=0;s--){var n=e[s];if(n.attrs.listening)if("Shape"===n.nodeType){var a=this._detectEvent(n,i);if(a)return!0}else{var a=this._traverseChildren(n,i);if(a)return!0}}return!1},_handleStageEvent:function(t){var i=new Date,e=i.getTime();this.lastEventTime=e,Kinetic.GlobalObject,t||(t=window.event),this._setMousePosition(t),this._setTouchPosition(t),this.pathLayer.clear(),this.targetFound=!1;for(var s=!1,n=this.children.length-1;n>=0;n--){var a=this.children[n];a.isVisible()&&n>=0&&a.attrs.listening&&this._traverseChildren(a,t)&&(n=-1,s=!0)}!s&&this.mouseoutShape&&(this.mouseoutShape._handleEvents("mouseout",t),this.mouseoutShape=void 0)},_listen:function(){Kinetic.GlobalObject;var t=this;this.content.addEventListener("mousedown",function(i){t.mouseDown=!0,t.mouseUp=!1,t.mouseMove=!1,t._handleStageEvent(i),t.attrs.draggable&&t._initDrag()},!1),this.content.addEventListener("mousemove",function(i){var e=t.attrs.throttle,s=new Date,n=s.getTime(),a=n-t.lastEventTime,r=1e3/e;a>=r&&(t.mouseDown=!1,t.mouseUp=!1,t.mouseMove=!0,t._handleStageEvent(i))},!1),this.content.addEventListener("mouseup",function(i){t.mouseDown=!1,t.mouseUp=!0,t.mouseMove=!1,t._handleStageEvent(i),t.clickStart=!1},!1),this.content.addEventListener("mouseover",function(i){t._handleStageEvent(i)},!1),this.content.addEventListener("mouseout",function(i){var e=t.targetShape;e&&(e._handleEvents("mouseout",i),t.targetShape=void 0),t.mousePos=void 0},!1),this.content.addEventListener("touchstart",function(i){i.preventDefault(),t.touchStart=!0,t.touchEnd=!1,t.touchMove=!1,t._handleStageEvent(i),t.attrs.draggable&&t._initDrag()},!1),this.content.addEventListener("touchmove",function(i){var e=t.attrs.throttle,s=new Date,n=s.getTime(),a=n-t.lastEventTime,r=1e3/e;a>=r&&(i.preventDefault(),t.touchStart=!1,t.touchEnd=!1,t.touchMove=!0,t._handleStageEvent(i))},!1),this.content.addEventListener("touchend",function(i){t.touchStart=!1,t.touchEnd=!0,t.touchMove=!1,t._handleStageEvent(i),t.tapStart=!1},!1)},_setMousePosition:function(t){var i=t.offsetX||t.clientX-this._getContentPosition().left+window.pageXOffset,e=t.offsetY||t.clientY-this._getContentPosition().top+window.pageYOffset;this.mousePos={x:i,y:e}},_setTouchPosition:function(t){if(void 0!==t.touches&&1===t.touches.length){var i=t.touches[0],e=i.clientX-this._getContentPosition().left+window.pageXOffset,s=i.clientY-this._getContentPosition().top+window.pageYOffset;this.touchPos={x:e,y:s}}},_getContentPosition:function(){for(var t=this.content,i=0,e=0;t&&"BODY"!==t.tagName;)i+=t.offsetTop-t.scrollTop,e+=t.offsetLeft-t.scrollLeft,t=t.offsetParent;return{top:i,left:e}},_modifyPathContext:function(t){t.stroke=function(){},t.fill=function(){},t.fillRect=function(i,e,s,n){t.rect(i,e,s,n)},t.strokeRect=function(i,e,s,n){t.rect(i,e,s,n)},t.drawImage=function(){},t.fillText=function(){},t.strokeText=function(){}},_endDrag:function(t){var i=Kinetic.GlobalObject;i.drag.node&&i.drag.moving&&(i.drag.moving=!1,i.drag.node._handleEvents("dragend",t)),i.drag.node=void 0},_prepareDrag:function(){var t=this;this._onContent("mousemove touchmove",function(i){var e=Kinetic.GlobalObject,s=e.drag.node;if(s){var n=t.getUserPosition(),a=s.attrs.dragConstraint,r=s.attrs.dragBounds,h={x:s.attrs.x,y:s.attrs.y},o={x:n.x-e.drag.offset.x,y:n.y-e.drag.offset.y};void 0!==r.left&&o.x<r.left&&(o.x=r.left),void 0!==r.right&&o.x>r.right&&(o.x=r.right),void 0!==r.top&&o.y<r.top&&(o.y=r.top),void 0!==r.bottom&&o.y>r.bottom&&(o.y=r.bottom),s.setAbsolutePosition(o),"horizontal"===a?s.attrs.y=h.y:"vertical"===a&&(s.attrs.x=h.x),"Stage"===e.drag.node.nodeType?e.drag.node.draw():e.drag.node.getLayer().draw(),e.drag.moving||(e.drag.moving=!0,e.drag.node._handleEvents("dragstart",i)),e.drag.node._handleEvents("dragmove",i)}},!1),this._onContent("mouseup touchend mouseout",function(i){t._endDrag(i)})},_buildDOM:function(){this.content.style.position="relative",this.content.style.display="inline-block",this.content.className="kineticjs-content",this.attrs.container.appendChild(this.content),this.bufferLayer=new Kinetic.Layer({name:"bufferLayer"}),this.pathLayer=new Kinetic.Layer({name:"pathLayer"}),this.bufferLayer.parent=this,this.pathLayer.parent=this,this._modifyPathContext(this.pathLayer.context),this.bufferLayer.getCanvas().style.display="none",this.pathLayer.getCanvas().style.display="none",this.bufferLayer.canvas.className="kineticjs-buffer-layer",this.content.appendChild(this.bufferLayer.canvas),this.pathLayer.canvas.className="kineticjs-path-layer",this.content.appendChild(this.pathLayer.canvas),this.setSize(this.attrs.width,this.attrs.height)},_addId:function(t){void 0!==t.attrs.id&&(this.ids[t.attrs.id]=t)},_removeId:function(t){void 0!==t.attrs.id&&(this.ids[t.attrs.id]=void 0)},_addName:function(t){var i=t.attrs.name;void 0!==i&&(void 0===this.names[i]&&(this.names[i]=[]),this.names[i].push(t))},_removeName:function(t){if(void 0!==t.attrs.name){var i=this.names[t.attrs.name];if(void 0!==i){for(var e=0;i.length>e;e++){var s=i[e];s._id===t._id&&i.splice(e,1)}0===i.length&&(this.names[t.attrs.name]=void 0)}}},_onContent:function(t,i){for(var e=t.split(" "),s=0;e.length>s;s++){var n=e[s];this.content.addEventListener(n,i,!1)}},_setStageDefaultProperties:function(){this.targetShape=void 0,this.targetFound=!1,this.mouseoverShape=void 0,this.mouseoutShape=void 0,this.mousePos=void 0,this.mouseDown=!1,this.mouseUp=!1,this.mouseMove=!1,this.clickStart=!1,this.touchPos=void 0,this.touchStart=!1,this.touchEnd=!1,this.touchMove=!1,this.tapStart=!1,this.ids={},this.names={},this.anim=void 0,this.animRunning=!1}},Kinetic.GlobalObject.extend(Kinetic.Stage,Kinetic.Container),Kinetic.GlobalObject.extend(Kinetic.Stage,Kinetic.Node),Kinetic.Layer=function(t){this.setDefaultAttrs({throttle:80}),this.nodeType="Layer",this.lastDrawTime=0,this.beforeDrawFunc=void 0,this.afterDrawFunc=void 0,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.style.position="absolute",Kinetic.Container.apply(this,[]),Kinetic.Node.apply(this,[t])},Kinetic.Layer.prototype={draw:function(){var t=this.attrs.throttle,i=new Date,e=i.getTime(),s=e-this.lastDrawTime,n=1e3/t;if(s>=n)this._draw(),void 0!==this.drawTimeout&&(clearTimeout(this.drawTimeout),this.drawTimeout=void 0);else if(void 0===this.drawTimeout){var a=this;this.drawTimeout=setTimeout(function(){a.draw()},17)}},setThrottle:function(t){this.attrs.throttle=t},getThrottle:function(){return this.attrs.throttle},beforeDraw:function(t){this.beforeDrawFunc=t},afterDraw:function(t){this.afterDrawFunc=t},clear:function(){var t=this.getContext(),i=this.getCanvas();t.clearRect(0,0,i.width,i.height)},getCanvas:function(){return this.canvas},getContext:function(){return this.context},_draw:function(){var t=new Date,i=t.getTime();this.lastDrawTime=i,void 0!==this.beforeDrawFunc&&this.beforeDrawFunc.call(this),this.clear(),this.isVisible()&&(void 0!==this.attrs.drawFunc&&this.attrs.drawFunc.call(this),this._drawChildren()),void 0!==this.afterDrawFunc&&this.afterDrawFunc.call(this)}},Kinetic.GlobalObject.extend(Kinetic.Layer,Kinetic.Container),Kinetic.GlobalObject.extend(Kinetic.Layer,Kinetic.Node),Kinetic.Group=function(t){this.nodeType="Group",Kinetic.Container.apply(this,[]),Kinetic.Node.apply(this,[t])},Kinetic.Group.prototype={draw:function(){this.attrs.visible&&this._drawChildren()}},Kinetic.GlobalObject.extend(Kinetic.Group,Kinetic.Container),Kinetic.GlobalObject.extend(Kinetic.Group,Kinetic.Node),Kinetic.Shape=function(t){this.setDefaultAttrs({fill:void 0,stroke:void 0,strokeWidth:void 0,lineJoin:void 0,detectionType:"path",shadow:{blur:10,alpha:1,offset:{x:0,y:0}}}),this.data=[],this.nodeType="Shape",this.appliedShadow=!1,Kinetic.Node.apply(this,[t])},Kinetic.Shape.prototype={getContext:function(){return void 0===this.tempLayer?null:this.tempLayer.getContext()},getCanvas:function(){return this.tempLayer.getCanvas()},stroke:function(){var t=!1,i=this.getContext();if(i.save(),this.attrs.stroke||this.attrs.strokeWidth){this.appliedShadow||(t=this._applyShadow());var e=this.attrs.stroke?this.attrs.stroke:"black",s=this.attrs.strokeWidth?this.attrs.strokeWidth:2;i.lineWidth=s,i.strokeStyle=e,i.stroke()}i.restore(),t&&this.stroke()},fill:function(){var t=!1,i=this.getContext();i.save();var e=this.attrs.fill;if(e){this.appliedShadow||(t=this._applyShadow());var s=e.start,n=e.end,a=null;if("string"==typeof e)a=this.attrs.fill,i.fillStyle=a,i.fill();else if(void 0!==e.image){var r=void 0===e.repeat?"repeat":e.repeat;a=i.createPattern(e.image,r),i.save(),void 0!==e.offset&&i.translate(e.offset.x,e.offset.y),i.fillStyle=a,i.fill(),i.restore()}else if(void 0===s.radius&&void 0===n.radius){for(var i=this.getContext(),h=i.createLinearGradient(s.x,s.y,n.x,n.y),o=e.colorStops,c=0;o.length>c;c+=2)h.addColorStop(o[c],o[c+1]);a=h,i.fillStyle=a,i.fill()}else if(void 0!==s.radius&&void 0!==n.radius){for(var i=this.getContext(),h=i.createRadialGradient(s.x,s.y,s.radius,n.x,n.y,n.radius),o=e.colorStops,c=0;o.length>c;c+=2)h.addColorStop(o[c],o[c+1]);a=h,i.fillStyle=a,i.fill()}else a="black",i.fillStyle=a,i.fill()}i.restore(),t&&this.fill()},fillText:function(t,i,e){var s=!1,n=this.getContext();n.save(),void 0!==this.attrs.textFill&&(this.appliedShadow||(s=this._applyShadow()),n.fillStyle=this.attrs.textFill,n.fillText(t,i,e)),n.restore(),s&&this.fillText(t,i,e)},strokeText:function(t,i,e){var s=!1,n=this.getContext();n.save(),(void 0!==this.attrs.textStroke||void 0!==this.attrs.textStrokeWidth)&&(this.appliedShadow||(s=this._applyShadow()),void 0===this.attrs.textStroke?this.attrs.textStroke="black":void 0===this.attrs.textStrokeWidth&&(this.attrs.textStrokeWidth=2),n.lineWidth=this.attrs.textStrokeWidth,n.strokeStyle=this.attrs.textStroke,n.strokeText(t,i,e)),n.restore(),s&&this.strokeText(t,i,e)},drawImage:function(){var t=!1,i=this.getContext();i.save();var e=arguments;if(5===e.length||9===e.length)switch(this.appliedShadow||(t=this._applyShadow()),e.length){case 5:i.drawImage(e[0],e[1],e[2],e[3],e[4]);break;case 9:i.drawImage(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}i.restore(),t&&this.drawImage.apply(this,arguments)},applyLineJoin:function(){var t=this.getContext();void 0!==this.attrs.lineJoin&&(t.lineJoin=this.attrs.lineJoin)},_applyShadow:function(){var t=this.getContext(),i=this.attrs.shadow;if(void 0!==i){var e=this.getAbsoluteAlpha(),s=this.attrs.shadow.alpha;if(void 0!==s&&void 0!==i.color)return t.globalAlpha=s*e,t.shadowColor=i.color,t.shadowBlur=i.blur,t.shadowOffsetX=i.offset.x,t.shadowOffsetY=i.offset.y,this.appliedShadow=!0,!0}return!1},setFill:function(t){this.setAttrs({fill:t})},getFill:function(){return this.attrs.fill},setStroke:function(t){this.attrs.stroke=t},getStroke:function(){return this.attrs.stroke},setLineJoin:function(t){this.attrs.lineJoin=t},getLineJoin:function(){return this.attrs.lineJoin},setStrokeWidth:function(t){this.attrs.strokeWidth=t},getStrokeWidth:function(){return this.attrs.strokeWidth},setShadow:function(t){this.setAttrs({shadow:t})},getShadow:function(){return this.attrs.shadow},setDrawFunc:function(t){this.attrs.drawFunc=t},saveData:function(){var t=this.getStage(),i=t.attrs.width,e=t.attrs.height,s=t.bufferLayer,n=s.getContext();s.clear(),this._draw(s);var a=n.getImageData(0,0,i,e);this.data=a.data},clearData:function(){this.data=[]},intersects:function(){var t=Kinetic.GlobalObject._getXY(arguments),i=this.getStage();if("path"===this.attrs.detectionType){var e=i.pathLayer,s=e.getContext();return this._draw(e),s.isPointInPath(t.x,t.y)}var n=i.attrs.width,a=this.data[4*(n*t.y+t.x)+3];return void 0!==a&&0!==a},_draw:function(t){if(void 0!==t&&void 0!==this.attrs.drawFunc){t.getStage();var i=t.getContext(),e=[],s=this.parent;for(e.unshift(this);s;)e.unshift(s),s=s.parent;i.save();for(var n=0;e.length>n;n++){var a=e[n],r=a.getTransform();(0!==a.attrs.centerOffset.x||0!==a.attrs.centerOffset.y)&&r.translate(-1*a.attrs.centerOffset.x,-1*a.attrs.centerOffset.y);var h=r.getMatrix();i.transform(h[0],h[1],h[2],h[3],h[4],h[5])}this.tempLayer=t,1!==this.getAbsoluteAlpha()&&(i.globalAlpha=this.getAbsoluteAlpha()),this.applyLineJoin(),this.appliedShadow=!1,this.attrs.drawFunc.call(this),i.restore()}}},Kinetic.GlobalObject.extend(Kinetic.Shape,Kinetic.Node),Kinetic.Rect=function(t){this.setDefaultAttrs({width:0,height:0,cornerRadius:0}),this.shapeType="Rect",t.drawFunc=function(){var t=this.getContext();t.beginPath(),0===this.attrs.cornerRadius?t.rect(0,0,this.attrs.width,this.attrs.height):(t.moveTo(this.attrs.cornerRadius,0),t.lineTo(this.attrs.width-this.attrs.cornerRadius,0),t.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,3*Math.PI/2,0,!1),t.lineTo(this.attrs.width,this.attrs.height-this.attrs.cornerRadius),t.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,!1),t.lineTo(this.attrs.cornerRadius,this.attrs.height),t.arc(this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,!1),t.lineTo(0,this.attrs.cornerRadius),t.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,3*Math.PI/2,!1)),t.closePath(),this.fill(),this.stroke()},Kinetic.Shape.apply(this,[t])},Kinetic.Rect.prototype={setWidth:function(t){this.attrs.width=t},getWidth:function(){return this.attrs.width},setHeight:function(t){this.attrs.height=t},getHeight:function(){return this.attrs.height},setSize:function(){var t=Kinetic.GlobalObject._getSize(arguments);this.setAttrs(t)},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}},setCornerRadius:function(t){this.attrs.cornerRadius=t},getCornerRadius:function(){return this.attrs.cornerRadius}},Kinetic.GlobalObject.extend(Kinetic.Rect,Kinetic.Shape),Kinetic.Circle=function(t){this.setDefaultAttrs({radius:0}),this.shapeType="Circle",t.drawFunc=function(){this.getCanvas();var t=this.getContext();t.beginPath(),t.arc(0,0,this.attrs.radius,0,2*Math.PI,!0),t.closePath(),this.fill(),this.stroke()
},Kinetic.Shape.apply(this,[t])},Kinetic.Circle.prototype={setRadius:function(t){this.attrs.radius=t},getRadius:function(){return this.attrs.radius}},Kinetic.GlobalObject.extend(Kinetic.Circle,Kinetic.Shape),Kinetic.Image=function(t){this.setDefaultAttrs({crop:{x:0,y:0,width:void 0,height:void 0}}),this.shapeType="Image",t.drawFunc=function(){if(void 0!==this.attrs.image){var t=void 0!==this.attrs.width?this.attrs.width:this.attrs.image.width,i=void 0!==this.attrs.height?this.attrs.height:this.attrs.image.height,e=this.attrs.crop.x,s=this.attrs.crop.y,n=this.attrs.crop.width,a=this.attrs.crop.height;this.getCanvas();var r=this.getContext();r.beginPath(),r.rect(0,0,t,i),r.closePath(),this.fill(),this.stroke(),void 0!==n&&void 0!==a?this.drawImage(this.attrs.image,e,s,n,a,0,0,t,i):this.drawImage(this.attrs.image,0,0,t,i)}},Kinetic.Shape.apply(this,[t])},Kinetic.Image.prototype={setImage:function(t){this.attrs.image=t},getImage:function(){return this.attrs.image},setWidth:function(t){this.attrs.width=t},getWidth:function(){return this.attrs.width},setHeight:function(t){this.attrs.height=t},getHeight:function(){return this.attrs.height},setSize:function(){var t=Kinetic.GlobalObject._getSize(arguments);this.setAttrs(t)},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}},getCrop:function(){return this.attrs.crop},setCrop:function(){this.setAttrs({crop:arguments})}},Kinetic.GlobalObject.extend(Kinetic.Image,Kinetic.Shape),Kinetic.Sprite=function(t){this.setDefaultAttrs({index:0,frameRate:17}),t.drawFunc=function(){if(void 0!==this.attrs.image){var t=this.getContext(),i=this.attrs.animation,e=this.attrs.index,s=this.attrs.animations[i][e];t.beginPath(),t.rect(0,0,s.width,s.height),t.closePath(),this.drawImage(this.attrs.image,s.x,s.y,s.width,s.height,0,0,s.width,s.height)}},Kinetic.Shape.apply(this,[t])},Kinetic.Sprite.prototype={start:function(){var t=this,i=this.getLayer();this.interval=setInterval(function(){t._updateIndex(),i.draw(),t.afterFrameFunc&&t.attrs.index===t.afterFrameIndex&&t.afterFrameFunc()},1e3/this.attrs.frameRate)},stop:function(){clearInterval(this.interval)},afterFrame:function(t,i){this.afterFrameIndex=t,this.afterFrameFunc=i},setAnimation:function(t){this.attrs.animation=t},setAnimations:function(t){this.attrs.animations=t},getAnimations:function(){return this.attrs.animations},getAnimation:function(){return this.attrs.animation},setIndex:function(t){this.attrs.index=t},_updateIndex:function(){var t=this.attrs.index,i=this.attrs.animation;this.attrs.animations[i].length-1>t?this.attrs.index++:this.attrs.index=0}},Kinetic.GlobalObject.extend(Kinetic.Sprite,Kinetic.Shape),Kinetic.Polygon=function(t){this.setDefaultAttrs({points:[]}),this.shapeType="Polygon",t.drawFunc=function(){var t=this.getContext();t.beginPath(),t.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var i=1;this.attrs.points.length>i;i++)t.lineTo(this.attrs.points[i].x,this.attrs.points[i].y);t.closePath(),this.fill(),this.stroke()},Kinetic.Shape.apply(this,[t])},Kinetic.Polygon.prototype={setPoints:function(t){this.setAttrs({points:t})},getPoints:function(){return this.attrs.points}},Kinetic.GlobalObject.extend(Kinetic.Polygon,Kinetic.Shape),Kinetic.RegularPolygon=function(t){this.setDefaultAttrs({radius:0,sides:0}),this.shapeType="RegularPolygon",t.drawFunc=function(){var t=this.getContext();t.beginPath(),t.moveTo(0,0-this.attrs.radius);for(var i=1;this.attrs.sides>i;i++){var e=this.attrs.radius*Math.sin(2*i*Math.PI/this.attrs.sides),s=-1*this.attrs.radius*Math.cos(2*i*Math.PI/this.attrs.sides);t.lineTo(e,s)}t.closePath(),this.fill(),this.stroke()},Kinetic.Shape.apply(this,[t])},Kinetic.RegularPolygon.prototype={setRadius:function(t){this.attrs.radius=t},getRadius:function(){return this.attrs.radius},setSides:function(t){this.attrs.sides=t},getSides:function(){return this.attrs.sides}},Kinetic.GlobalObject.extend(Kinetic.RegularPolygon,Kinetic.Shape),Kinetic.Star=function(t){this.setDefaultAttrs({numPoints:0,innerRadius:0,outerRadius:0}),this.shapeType="Star",t.drawFunc=function(){var t=this.getContext();t.beginPath(),t.moveTo(0,0-this.attrs.outerRadius);for(var i=1;2*this.attrs.numPoints>i;i++){var e=0===i%2?this.attrs.outerRadius:this.attrs.innerRadius,s=e*Math.sin(i*Math.PI/this.attrs.numPoints),n=-1*e*Math.cos(i*Math.PI/this.attrs.numPoints);t.lineTo(s,n)}t.closePath(),this.fill(),this.stroke()},Kinetic.Shape.apply(this,[t])},Kinetic.Star.prototype={setNumPoints:function(t){this.attrs.numPoints=t},getNumPoints:function(){return this.attrs.numPoints},setOuterRadius:function(t){this.attrs.outerRadius=t},getOuterRadius:function(){return this.attrs.outerRadius},setInnerRadius:function(t){this.attrs.innerRadius=t},getInnerRadius:function(){return this.attrs.innerRadius}},Kinetic.GlobalObject.extend(Kinetic.Star,Kinetic.Shape),Kinetic.Text=function(t){this.setDefaultAttrs({fontFamily:"Calibri",text:"",fontSize:12,align:"left",verticalAlign:"top",padding:0,fontStyle:"normal",width:"auto",detectionType:"pixel"}),this.shapeType="Text",t.drawFunc=function(){var t=this.getContext();t.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily,t.textBaseline="middle";var i=this.getTextHeight(),e="auto"===this.attrs.width?this.getTextWidth():this.attrs.width,s=this.attrs.padding,n=0,a=0;switch(this.attrs.align){case"center":n=e/-2-s;break;case"right":n=-1*e-s}switch(this.attrs.verticalAlign){case"middle":a=i/-2-s;break;case"bottom":a=-1*i-s}t.save(),t.beginPath(),t.rect(n,a,e+2*s,i+2*s),t.closePath(),this.fill(),this.stroke(),t.restore();var r=s+n,h=i/2+s+a;t.save(),"auto"!==this.attrs.width&&(t.beginPath(),t.rect(n,a,e+s,i+2*s),t.closePath(),t.clip()),this.fillText(this.attrs.text,r,h),this.strokeText(this.attrs.text,r,h),t.restore()},Kinetic.Shape.apply(this,[t])},Kinetic.Text.prototype={setFontFamily:function(t){this.attrs.fontFamily=t},getFontFamily:function(){return this.attrs.fontFamily},setFontSize:function(t){this.attrs.fontSize=t},getFontSize:function(){return this.attrs.fontSize},setFontStyle:function(t){this.attrs.fontStyle=t},getFontStyle:function(){return this.attrs.fontStyle},setTextFill:function(t){this.attrs.textFill=t},getTextFill:function(){return this.attrs.textFill},setTextStroke:function(t){this.attrs.textStroke=t},getTextStroke:function(){return this.attrs.textStroke},setTextStrokeWidth:function(t){this.attrs.textStrokeWidth=t},getTextStrokeWidth:function(){return this.attrs.textStrokeWidth},setPadding:function(t){this.attrs.padding=t},getPadding:function(){return this.attrs.padding},setAlign:function(t){this.attrs.align=t},getAlign:function(){return this.attrs.align},setVerticalAlign:function(t){this.attrs.verticalAlign=t},getVerticalAlign:function(){return this.attrs.verticalAlign},setText:function(t){this.attrs.text=t},getText:function(){return this.attrs.text},getTextWidth:function(){return this.getTextSize().width},getTextHeight:function(){return this.getTextSize().height},getTextSize:function(){var t=this.getContext();if(!t){var i=document.createElement("canvas");t=i.getContext("2d")}t.save(),t.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;var e=t.measureText(this.attrs.text);return t.restore(),{width:e.width,height:parseInt(this.attrs.fontSize,10)}},getWidth:function(){return this.attrs.width},setWidth:function(t){this.attrs.width=t}},Kinetic.GlobalObject.extend(Kinetic.Text,Kinetic.Shape),Kinetic.Line=function(t){this.setDefaultAttrs({points:[],lineCap:"butt",dashArray:[],detectionType:"pixel"}),this.shapeType="Line",t.drawFunc=function(){var t=this.getContext();t.beginPath(),t.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var i=1;this.attrs.points.length>i;i++){var e=this.attrs.points[i].x,s=this.attrs.points[i].y;if(this.attrs.dashArray.length>0){var n=this.attrs.points[i-1].x,a=this.attrs.points[i-1].y;this._dashedLine(n,a,e,s,this.attrs.dashArray)}else t.lineTo(e,s)}this.attrs.lineCap&&(t.lineCap=this.attrs.lineCap),this.stroke()},Kinetic.Shape.apply(this,[t])},Kinetic.Line.prototype={setPoints:function(t){this.setAttrs({points:t})},getPoints:function(){return this.attrs.points},setLineCap:function(t){this.attrs.lineCap=t},getLineCap:function(){return this.attrs.lineCap},setDashArray:function(t){this.attrs.dashArray=t},getDashArray:function(){return this.attrs.dashArray},_dashedLine:function(t,i,e,s,n){var a=this.getContext(),r=n.length,h=e-t,o=s-i,c=h>o,u=c?o/h:h/o;u>9999?u=9999:-9999>u&&(u=-9999);for(var d=Math.sqrt(h*h+o*o),l=0,f=!0;d>=.1&&1e4>l;){var g=n[l++%r];0===g&&(g=.001),g>d&&(g=d);var p=Math.sqrt(g*g/(1+u*u));c?(t+=0>h&&0>o?-1*p:p,i+=0>h&&0>o?-1*u*p:u*p):(t+=0>h&&0>o?-1*u*p:u*p,i+=0>h&&0>o?-1*p:p),a[f?"lineTo":"moveTo"](t,i),d-=g,f=!f}a.moveTo(e,s)}},Kinetic.GlobalObject.extend(Kinetic.Line,Kinetic.Shape),Kinetic.Path=function(t){this.shapeType="Path",this.dataArray=[],t.drawFunc=function(){var t=this.getContext(),i=this.dataArray;t.beginPath();for(var e=0;i.length>e;e++){var s=i[e].command,n=i[e].points;switch(s){case"L":t.lineTo(n[0],n[1]);break;case"M":t.moveTo(n[0],n[1]);break;case"C":t.bezierCurveTo(n[0],n[1],n[2],n[3],n[4],n[5]);break;case"Q":t.quadraticCurveTo(n[0],n[1],n[2],n[3]);break;case"z":t.closePath()}}this.fill(),this.stroke()},Kinetic.Shape.apply(this,[t]),this.dataArray=this.getDataArray()},Kinetic.Path.prototype={getDataArray:function(){var t=this.attrs.data,i=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S"];t=t.replace(new RegExp(" ","g"),",");for(var e=0;i.length>e;e++)t=t.replace(new RegExp(i[e],"g"),"|"+i[e]);for(var s=t.split("|"),n=[],a=0,r=0,e=1;s.length>e;e++){var h=s[e],o=h.charAt(0);h=h.slice(1),h=h.replace(new RegExp(",-","g"),"-"),h=h.replace(new RegExp("-","g"),",-");var c=h.split(",");c.length>0&&""===c[0]&&c.shift();for(var u=0;c.length>u;u++)c[u]=parseFloat(c[u]);for(;c.length>0&&!isNaN(c[0]);){var d=void 0,l=[];switch(o){case"l":a+=c.shift(),r+=c.shift(),d="L",l.push(a,r);break;case"L":a=c.shift(),r=c.shift(),l.push(a,r);break;case"m":a+=c.shift(),r+=c.shift(),d="M",l.push(a,r),o="l";break;case"M":a=c.shift(),r=c.shift(),d="M",l.push(a,r),o="L";break;case"h":a+=c.shift(),d="L",l.push(a,r);break;case"H":a=c.shift(),d="L",l.push(a,r);break;case"v":r+=c.shift(),d="L",l.push(a,r);break;case"V":r=c.shift(),d="L",l.push(a,r);break;case"C":l.push(c.shift(),c.shift(),c.shift(),c.shift()),a=c.shift(),r=c.shift(),l.push(a,r);break;case"c":l.push(a+c.shift(),r+c.shift(),a+c.shift(),r+c.shift()),a+=c.shift(),r+=c.shift(),d="C",l.push(a,r);break;case"S":var f=a,g=r,p=n[n.length-1];"C"===p.command&&(f=a+(a-p.points[2]),g=r+(r-p.points[3])),l.push(f,g,c.shift(),c.shift()),a=c.shift(),r=c.shift(),d="C",l.push(a,r);break;case"s":var f=a,g=r,p=n[n.length-1];"C"===p.command&&(f=a+(a-p.points[2]),g=r+(r-p.points[3])),l.push(f,g,a+c.shift(),r+c.shift()),a+=c.shift(),r+=c.shift(),d="C",l.push(a,r);break;case"Q":l.push(c.shift(),c.shift()),a=c.shift(),r=c.shift(),l.push(a,r);break;case"q":l.push(a+c.shift(),r+c.shift()),a+=c.shift(),r+=c.shift(),d="Q",l.push(a,r);break;case"T":var f=a,g=r,p=n[n.length-1];"Q"===p.command&&(f=a+(a-p.points[0]),g=r+(r-p.points[1])),a=c.shift(),r=c.shift(),d="Q",l.push(f,g,a,r);break;case"t":var f=a,g=r,p=n[n.length-1];"Q"===p.command&&(f=a+(a-p.points[0]),g=r+(r-p.points[1])),a+=c.shift(),r+=c.shift(),d="Q",l.push(f,g,a,r)}n.push({command:d||o,points:l})}("z"===o||"Z"===o)&&n.push({command:"z",points:[]})}return n},getData:function(){return this.attrs.data},setData:function(t){this.attrs.data=t,this.dataArray=this.getDataArray()}},Kinetic.GlobalObject.extend(Kinetic.Path,Kinetic.Shape),Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]},Kinetic.Transform.prototype={translate:function(t,i){this.m[4]+=this.m[0]*t+this.m[2]*i,this.m[5]+=this.m[1]*t+this.m[3]*i},scale:function(t,i){this.m[0]*=t,this.m[1]*=t,this.m[2]*=i,this.m[3]*=i},rotate:function(t){var i=Math.cos(t),e=Math.sin(t),s=this.m[0]*i+this.m[2]*e,n=this.m[1]*i+this.m[3]*e,a=this.m[0]*-e+this.m[2]*i,r=this.m[1]*-e+this.m[3]*i;this.m[0]=s,this.m[1]=n,this.m[2]=a,this.m[3]=r},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},multiply:function(t){var i=this.m[0]*t.m[0]+this.m[2]*t.m[1],e=this.m[1]*t.m[0]+this.m[3]*t.m[1],s=this.m[0]*t.m[2]+this.m[2]*t.m[3],n=this.m[1]*t.m[2]+this.m[3]*t.m[3],a=this.m[0]*t.m[4]+this.m[2]*t.m[5]+this.m[4],r=this.m[1]*t.m[4]+this.m[3]*t.m[5]+this.m[5];this.m[0]=i,this.m[1]=e,this.m[2]=s,this.m[3]=n,this.m[4]=a,this.m[5]=r},invert:function(){var t=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),i=this.m[3]*t,e=-this.m[1]*t,s=-this.m[2]*t,n=this.m[0]*t,a=t*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),r=t*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=i,this.m[1]=e,this.m[2]=s,this.m[3]=n,this.m[4]=a,this.m[5]=r},getMatrix:function(){return this.m}},Kinetic.Transition=function(t,i){function e(t,i){for(var n in t)"duration"!==n&&"easing"!==n&&"callback"!==n&&(Kinetic.GlobalObject._isObject(t[n])?e(t[n],i[n]):s._add(s._getTween(i,n,t[n])))}this.node=t,this.config=i,this.tweens=[];var s=this;e(i,t.attrs);for(var n=0,a=0;this.tweens.length>a;a++){var r=this.tweens[a];r.onFinished=function(){n++,n>=s.tweens.length&&s.onFinished()}}},Kinetic.Transition.prototype={start:function(){for(var t=0;this.tweens.length>t;t++)this.tweens[t].start()},stop:function(){for(var t=0;this.tweens.length>t;t++)this.tweens[t].stop()},resume:function(){for(var t=0;this.tweens.length>t;t++)this.tweens[t].resume()},_onEnterFrame:function(){for(var t=0;this.tweens.length>t;t++)this.tweens[t].onEnterFrame()},_add:function(t){this.tweens.push(t)},_getTween:function(t,i,e){var s=this.config,n=this.node,a=s.easing;void 0===a&&(a="linear");var r=new Kinetic.Tween(n,function(e){t[i]=e},Kinetic.Tweens[a],t[i],e,s.duration);return r}},Kinetic.Tween=function(t,i,e,s,n,a){this._listeners=[],this.addListener(this),this.obj=t,this.propFunc=i,this.begin=s,this._pos=s,this.setDuration(a),this.isPlaying=!1,this._change=0,this.prevTime=0,this.prevPos=0,this.looping=!1,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.name="",this.func=e,this.setFinish(n)},Kinetic.Tween.prototype={setTime:function(t){this.prevTime=this._time,t>this.getDuration()?this.looping?(this.rewind(t-this._duration),this.update(),this.broadcastMessage("onLooped",{target:this,type:"onLooped"})):(this._time=this._duration,this.update(),this.stop(),this.broadcastMessage("onFinished",{target:this,type:"onFinished"})):0>t?(this.rewind(),this.update()):(this._time=t,this.update())},getTime:function(){return this._time},setDuration:function(t){this._duration=null===t||0>=t?1e5:t},getDuration:function(){return this._duration},setPosition:function(t){this.prevPos=this._pos,this.propFunc(t),this._pos=t,this.broadcastMessage("onChanged",{target:this,type:"onChanged"})},getPosition:function(t){return void 0===t&&(t=this._time),this.func(t,this.begin,this._change,this._duration)},setFinish:function(t){this._change=t-this.begin},getFinish:function(){return this.begin+this._change},start:function(){this.rewind(),this.startEnterFrame(),this.broadcastMessage("onStarted",{target:this,type:"onStarted"})},rewind:function(t){this.stop(),this._time=void 0===t?0:t,this.fixTime(),this.update()},fforward:function(){this._time=this._duration,this.fixTime(),this.update()},update:function(){this.setPosition(this.getPosition(this._time))},startEnterFrame:function(){this.stopEnterFrame(),this.isPlaying=!0,this.onEnterFrame()},onEnterFrame:function(){this.isPlaying&&this.nextFrame()},nextFrame:function(){this.setTime((this.getTimer()-this._startTime)/1e3)},stop:function(){this.stopEnterFrame(),this.broadcastMessage("onStopped",{target:this,type:"onStopped"})},stopEnterFrame:function(){this.isPlaying=!1},continueTo:function(t,i){this.begin=this._pos,this.setFinish(t),void 0!==this._duration&&this.setDuration(i),this.start()},resume:function(){this.fixTime(),this.startEnterFrame(),this.broadcastMessage("onResumed",{target:this,type:"onResumed"})},yoyo:function(){this.continueTo(this.begin,this._time)},addListener:function(t){return this.removeListener(t),this._listeners.push(t)},removeListener:function(t){for(var i=this._listeners,e=i.length;e--;)if(i[e]==t)return i.splice(e,1),!0;return!1},broadcastMessage:function(){for(var t=[],i=0;arguments.length>i;i++)t.push(arguments[i]);for(var e=t.shift(),s=this._listeners,n=s.length,i=0;n>i;i++)s[i][e]&&s[i][e].apply(s[i],t)},fixTime:function(){this._startTime=this.getTimer()-1e3*this._time},getTimer:function(){return(new Date).getTime()-this._time}},Kinetic.Tweens={"back-ease-in":function(t,i,e,s){var n=1.70158;return e*(t/=s)*t*((n+1)*t-n)+i},"back-ease-out":function(t,i,e,s){var n=1.70158;return e*((t=t/s-1)*t*((n+1)*t+n)+1)+i},"back-ease-in-out":function(t,i,e,s){var n=1.70158;return 1>(t/=s/2)?e/2*t*t*(((n*=1.525)+1)*t-n)+i:e/2*((t-=2)*t*(((n*=1.525)+1)*t+n)+2)+i},"elastic-ease-in":function(t,i,e,s,n,a){var r=0;return 0===t?i:1==(t/=s)?i+e:(a||(a=.3*s),!n||Math.abs(e)>n?(n=e,r=a/4):r=a/(2*Math.PI)*Math.asin(e/n),-(n*Math.pow(2,10*(t-=1))*Math.sin((t*s-r)*2*Math.PI/a))+i)},"elastic-ease-out":function(t,i,e,s,n,a){var r=0;return 0===t?i:1==(t/=s)?i+e:(a||(a=.3*s),!n||Math.abs(e)>n?(n=e,r=a/4):r=a/(2*Math.PI)*Math.asin(e/n),n*Math.pow(2,-10*t)*Math.sin((t*s-r)*2*Math.PI/a)+e+i)},"elastic-ease-in-out":function(t,i,e,s,n,a){var r=0;return 0===t?i:2==(t/=s/2)?i+e:(a||(a=s*.3*1.5),!n||Math.abs(e)>n?(n=e,r=a/4):r=a/(2*Math.PI)*Math.asin(e/n),1>t?-.5*n*Math.pow(2,10*(t-=1))*Math.sin((t*s-r)*2*Math.PI/a)+i:.5*n*Math.pow(2,-10*(t-=1))*Math.sin((t*s-r)*2*Math.PI/a)+e+i)},"bounce-ease-out":function(t,i,e,s){return 1/2.75>(t/=s)?e*7.5625*t*t+i:2/2.75>t?e*(7.5625*(t-=1.5/2.75)*t+.75)+i:2.5/2.75>t?e*(7.5625*(t-=2.25/2.75)*t+.9375)+i:e*(7.5625*(t-=2.625/2.75)*t+.984375)+i},"bounce-ease-in":function(t,i,e,s){return e-Kinetic.Tweens["bounce-ease-out"](s-t,0,e,s)+i},"bounce-ease-in-out":function(t,i,e,s){return s/2>t?.5*Kinetic.Tweens["bounce-ease-in"](2*t,0,e,s)+i:.5*Kinetic.Tweens["bounce-ease-out"](2*t-s,0,e,s)+.5*e+i},"ease-in":function(t,i,e,s){return e*(t/=s)*t+i},"ease-out":function(t,i,e,s){return-e*(t/=s)*(t-2)+i},"ease-in-out":function(t,i,e,s){return 1>(t/=s/2)?e/2*t*t+i:-e/2*(--t*(t-2)-1)+i},"strong-ease-in":function(t,i,e,s){return e*(t/=s)*t*t*t*t+i},"strong-ease-out":function(t,i,e,s){return e*((t=t/s-1)*t*t*t*t+1)+i},"strong-ease-in-out":function(t,i,e,s){return 1>(t/=s/2)?e/2*t*t*t*t*t+i:e/2*((t-=2)*t*t*t*t+2)+i},linear:function(t,i,e,s){return e*t/s+i}};